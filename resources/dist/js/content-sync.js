const d=typeof window<"u"&&window.__CONTENT_SYNC_ENDPOINTS__||{},f=typeof window<"u"&&window.__CONTENT_SYNC_CSRF__||"";async function h(s){const t=await fetch(`${d.options}?type=${encodeURIComponent(s)}`,{credentials:"same-origin"});if(!t.ok)throw new Error(`Options failed (${t.status})`);return(await t.json()).options||[]}async function y(){const s=await fetch(`${d.options}?type=sites`,{credentials:"same-origin"});if(!s.ok)throw new Error(`Sites failed (${s.status})`);return(await s.json()).options||[]}async function g(s){const t=new FormData;Object.entries(s).forEach(([p,l])=>t.append(p,Array.isArray(l)?JSON.stringify(l):l??""));const e=await fetch(d.export,{method:"POST",headers:{"X-CSRF-TOKEN":f},credentials:"same-origin",body:t});if(!e.ok)throw new Error(`Export failed (${e.status})`);const a=await e.blob();let i="export.json";const n=e.headers.get("Content-Disposition")||"",r=/filename="?([^"]+)"?/i.exec(n);r&&(i=r[1]);const o=URL.createObjectURL(a),c=document.createElement("a");c.href=o,c.download=i,document.body.appendChild(c),c.click(),c.remove(),URL.revokeObjectURL(o);try{const p=await a.text();return{count:(JSON.parse(p).items||[]).length,path:i}}catch{return{count:0,path:i}}}async function v(s){const t=new FormData;t.append("file",s);const e=await fetch(d.preview,{method:"POST",headers:{"X-CSRF-TOKEN":f},credentials:"same-origin",body:t});if(!e.ok)throw new Error(`Preview failed (${e.status})`);return e.json()}async function b(s){const t=await fetch(d.commit,{method:"POST",headers:{"X-CSRF-TOKEN":f,"Content-Type":"application/json"},credentials:"same-origin",body:JSON.stringify(s)});if(!t.ok)throw new Error(`Commit failed (${t.status})`);return t.json()}function m(s,t,e,a,i,n,r,o){var c=typeof s=="function"?s.options:s;return t&&(c.render=t,c.staticRenderFns=e,c._compiled=!0),n&&(c._scopeId="data-v-"+n),{exports:s,options:c}}const _={data(){return{types:["collections","taxonomies","navigation","globals","assets"],type:"collections",handles:[],handleOptions:[],siteOptions:[],sites:[],sinceLocal:"",busy:!1,result:null}},async created(){this.siteOptions=await y(),this.handleOptions=await h(this.type)},watch:{async type(s){this.handles=[],this.handleOptions=await h(s)}},methods:{toISO(s){return s?new Date(s).toISOString():""},async runExport(){this.busy=!0;try{const s={type:this.type,handles:this.handles,sites:this.sites,since:this.toISO(this.sinceLocal),out:""};this.result=await g(s),Statamic.$toast.success("Export downloaded.")}catch(s){Statamic.$toast.error(s.message||"Export failed.")}finally{this.busy=!1}}}};var C=function(){var t=this,e=t._self._c;return e("div",{staticClass:"card p-6 space-y-5"},[t._m(0),e("div",{staticClass:"flex flex-wrap gap-4"},[e("div",{staticClass:"w-full lg:w-1/3"},[e("label",{staticClass:"block font-medium mb-1"},[t._v("Type")]),e("v-select",{attrs:{options:t.types,clearable:!1},model:{value:t.type,callback:function(a){t.type=a},expression:"type"}})],1),e("div",{staticClass:"w-full lg:w-1/3"},[e("label",{staticClass:"block font-medium mb-1"},[t._v("Sites")]),e("v-select",{attrs:{options:t.siteOptions,multiple:!0,reduce:a=>a},model:{value:t.sites,callback:function(a){t.sites=a},expression:"sites"}})],1),e("div",{staticClass:"w-full lg:w-1/3"},[e("label",{staticClass:"block font-medium mb-1"},[t._v("Since")]),e("input",{directives:[{name:"model",rawName:"v-model",value:t.sinceLocal,expression:"sinceLocal"}],staticClass:"input",attrs:{type:"datetime-local"},domProps:{value:t.sinceLocal},on:{input:function(a){a.target.composing||(t.sinceLocal=a.target.value)}}}),e("small",{staticClass:"text-gray-500"},[t._v("Optional. Filters by updated_at ≥ since.")])])]),e("div",[e("label",{staticClass:"block font-medium mb-1"},[t._v("Handles")]),e("v-select",{attrs:{options:t.handleOptions,multiple:!0,reduce:a=>a,taggable:!1,placeholder:"Select one or more"},model:{value:t.handles,callback:function(a){t.handles=a},expression:"handles"}}),t.handleOptions.length?t._e():e("div",{staticClass:"mt-2 text-gray-600 text-sm"},[t._v(" No handles available for “"+t._s(t.type)+"”. ")])],1),e("div",{staticClass:"flex items-center gap-3"},[e("button",{staticClass:"btn-primary",attrs:{disabled:t.busy},on:{click:t.runExport}},[t._v(t._s(t.busy?"Exporting…":"Export & Download"))]),t.result?e("span",{staticClass:"text-gray-600"},[t._v("Exported "),e("b",[t._v(t._s(t.result.count))]),t._v(" → "),e("code",[t._v(t._s(t.result.path))])]):t._e()])])},x=[function(){var s=this,t=s._self._c;return t("div",{staticClass:"flex items-start justify-between flex-wrap gap-4"},[t("div",[t("div",{staticClass:"font-bold text-lg"},[s._v("Export")]),t("div",{staticClass:"text-gray-600"},[s._v("Select a type, handles, sites and a “since” date/time. The file downloads locally and includes a tamper-proof signature.")])])])}],w=m(_,C,x,!1,null,null);const O=w.exports,k={name:"ChevronIcon",functional:!0,props:{open:{type:Boolean,default:!1}},render(s,{props:t}){return s("svg",{attrs:{viewBox:"0 0 20 20",fill:"currentColor",width:18,height:18,"aria-hidden":"true"},class:t.open?"transform rotate-180 text-gray-600":"text-gray-600"},[s("path",{attrs:{d:"M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z"}})])}},S={name:"ImportPanel",components:{ChevronIcon:k},data(){return{loading:!1,error:"",groups:null,type:"",open:{},strategy:"manual",autoAction:"incoming",decisions:{},committing:!1,totalChanged:0,strategyOptions:[{label:"Manual (review per item)",value:"manual"},{label:"Auto (apply one action to all)",value:"auto"}],acceptOptions:[{label:"Accept Incoming changes",value:"incoming"},{label:"Accept Current changes",value:"current"},{label:"Accept Both changes",value:"both"}]}},computed:{filteredGroups(){if(!this.groups)return null;const s={};let t=0;return Object.entries(this.groups).forEach(([e,a])=>{const i={};Object.entries(a).forEach(([n,r])=>{const o=(r||[]).filter(c=>!this.isMeaningfullyUnchanged(c,this.type));o.length&&(i[n]=o,t+=o.length)}),Object.keys(i).length&&(s[e]=i)}),this.totalChanged=t,s}},methods:{isOpen(s){return!!this.open[s]},toggle(s){this.$set(this.open,s,!this.open[s])},totalInSites(s){return Object.values(s).reduce((t,e)=>t+(Array.isArray(e)?e.length:0),0)},badge(s){return s==="create"?"badge-green":s==="update"?"badge-amber":"badge-gray"},pretty(s){try{return JSON.stringify(s,null,2)}catch{return String(s)}},escape(s){return String(s).replace(/[&<>]/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;"})[t])},labelFor(s){const t=this.acceptOptions.find(e=>e.value===s);return t?t.label:s},stableStringify(s){const t=new WeakSet,e=a=>{if(a&&typeof a=="object"){if(t.has(a))return;if(t.add(a),Array.isArray(a))return a.map(e);const i={};return Object.keys(a).sort().forEach(n=>{i[n]=e(a[n])}),i}return a};return JSON.stringify(e(s))},deepEqual(s,t){try{return this.stableStringify(s)===this.stableStringify(t)}catch{return!1}},relevantPair(s,t){const e=(s==null?void 0:s.current)??{},a=(s==null?void 0:s.incoming)??{};switch(t){case"collections":return[{data:e.data??{},published:"published"in e?!!e.published:void 0},{data:a.data??{},published:"published"in a?!!a.published:void 0}];case"taxonomies":case"globals":case"assets":return[{data:e.data??{}},{data:a.data??{}}];case"navigation":return[{tree:e.tree??[]},{tree:a.tree??[]}];default:return[e,a]}},isMeaningfullyUnchanged(s,t){const[e,a]=this.relevantPair(s,t);return this.deepEqual(e,a)},computeDiff(s){const[t,e]=this.relevantPair(s,this.type),a=[],i=(n,r,o="")=>{if(!(n&&typeof n=="object")&&!(r&&typeof r=="object")){n!==r&&a.push({path:o,status:n===void 0?"added":r===void 0?"removed":"changed",current:n,incoming:r});return}if(Array.isArray(n)||Array.isArray(r)){this.deepEqual(n??[],r??[])||a.push({path:o,status:n===void 0?"added":r===void 0?"removed":"changed",current:n,incoming:r});return}[...new Set([...n?Object.keys(n):[],...r?Object.keys(r):[]])].sort().forEach(u=>{i(n?n[u]:void 0,r?r[u]:void 0,o?`${o}.${u}`:u)})};return i(t,e,""),a},renderCurrentClean(s){return this.computeDiff(s).filter(e=>e.status==="removed"||e.status==="changed").map(e=>{const a=this.escape(typeof e.current=="string"?e.current:this.pretty(e.current));return`<span class="${e.status==="removed"?"line-del":"line-chg"}">- ${e.path}: ${a}</span>`}).join(`
`)||this.escape(this.pretty(this.relevantPair(s,this.type)[0]))},renderIncomingClean(s){return this.computeDiff(s).filter(e=>e.status==="added"||e.status==="changed").map(e=>{const a=this.escape(typeof e.incoming=="string"?e.incoming:this.pretty(e.incoming));return`<span class="${e.status==="added"?"line-add":"line-chg"}">+ ${e.path}: ${a}</span>`}).join(`
`)||this.escape(this.pretty(this.relevantPair(s,this.type)[1]))},finalMerge(s,t){const e=s.current,a=s.incoming;if(t==="incoming")return a;if(t==="current")return e;const i=(n,r)=>{if(Array.isArray(n)&&Array.isArray(r))return r;if(n&&typeof n=="object"&&r&&typeof r=="object"){const o={...n};return Object.keys(r).forEach(c=>{o[c]=i(n[c],r[c])}),o}return r!==void 0?r:n};return i(e,a)},onFile(s){const t=s.target.files&&s.target.files[0];t&&(this.loading=!0,this.error="",this.groups=null,this.decisions={},this.open={},v(t).then(e=>{this.type=e.type,this.groups=e.groups||{},Object.keys(this.groups).forEach(a=>this.$set(this.open,a,!0)),this.$nextTick(()=>{Object.values(this.filteredGroups||{}).forEach(a=>{Object.values(a).forEach(i=>{i.forEach(n=>this.$set(this.decisions,n.key,"incoming"))})})})}).catch(e=>{this.error=(e==null?void 0:e.message)||"Failed to analyze file."}).finally(()=>{this.loading=!1}))},async commit(){if(this.totalChanged===0){Statamic.$toast.info("Nothing to apply.");return}this.committing=!0;try{let s;if(this.strategy==="auto")s={type:this.type,strategy:"auto",auto_action:this.autoAction};else{const e=[];Object.values(this.filteredGroups).forEach(a=>{Object.values(a).forEach(i=>{i.forEach(n=>e.push({key:n.key,action:this.decisions[n.key]||"incoming"}))})}),s={type:this.type,strategy:"manual",decisions:e}}const t=await b(s);Statamic.$toast.success(`Updated ${t.results.updated}, Created ${t.results.created}, Skipped ${t.results.skipped}`)}catch(s){Statamic.$toast.error((s==null?void 0:s.message)||"Commit failed.")}finally{this.committing=!1}}}};var j=function(){var t=this,e=t._self._c;return e("div",{staticClass:"card p-6 space-y-5"},[e("div",{staticClass:"flex items-start justify-between flex-wrap gap-4"},[t._m(0),e("div",{staticClass:"flex items-center"},[e("input",{attrs:{type:"file",accept:"application/json,.json"},on:{change:t.onFile}})])]),t.loading?e("div",{staticClass:"py-8 text-center"},[e("loading-graphic"),e("div",{staticClass:"mt-2 text-gray-600"},[t._v("Analyzing…")])],1):t._e(),t.error?e("div",{staticClass:"text-red-700 bg-red-50 border border-red-200 rounded p-3"},[t._v(" "+t._s(t.error)+" ")]):t._e(),t.filteredGroups?e("div",[e("div",{staticClass:"flex flex-wrap items-end gap-4 mb-4"},[e("div",[e("label",{staticClass:"block font-medium mb-1"},[t._v("Review strategy")]),e("v-select",{staticStyle:{width:"200px"},attrs:{options:t.strategyOptions,reduce:a=>a.value,clearable:!1},model:{value:t.strategy,callback:function(a){t.strategy=a},expression:"strategy"}})],1),t.strategy==="auto"?e("div",[e("label",{staticClass:"block font-medium mb-1"},[t._v("Accept the change")]),e("v-select",{staticStyle:{width:"260px"},attrs:{options:t.acceptOptions,reduce:a=>a.value,clearable:!1},model:{value:t.autoAction,callback:function(a){t.autoAction=a},expression:"autoAction"}})],1):t._e(),e("div",{staticClass:"ml-auto"},[e("button",{staticClass:"btn-primary",attrs:{disabled:t.committing||t.totalChanged===0},on:{click:t.commit}},[t._v(" "+t._s(t.committing?"Committing…":t.strategy==="auto"?"Apply Auto Action":"Complete Import")+" ")])])]),t._l(t.filteredGroups,function(a,i){return e("div",{key:i,staticClass:"mb-3 border rounded"},[e("button",{staticClass:"w-full flex items-center justify-between px-3 py-2 bg-gray-100 hover:bg-gray-200",on:{click:function(n){return t.toggle(i)}}},[e("div",{staticClass:"font-semibold"},[t._v(" "+t._s(i)+" "),e("span",{staticClass:"text-gray-500"},[t._v("("+t._s(t.totalInSites(a))+")")])]),e("ChevronIcon",{attrs:{open:t.isOpen(i)}})],1),e("div",{directives:[{name:"show",rawName:"v-show",value:t.isOpen(i),expression:"isOpen(handle)"}],staticClass:"p-3 pt-2"},[t._l(a,function(n,r){return e("div",{key:i+"::"+r,staticClass:"mb-2 border rounded"},[e("button",{staticClass:"w-full flex items-center justify-between px-3 py-2 bg-gray-50 hover:bg-gray-100",on:{click:function(o){return t.toggle(i+"::"+r)}}},[e("div",[e("span",{staticClass:"font-medium"},[t._v("Site:")]),t._v(" "+t._s(r)+" "),e("span",{staticClass:"text-gray-500"},[t._v("("+t._s(n.length)+")")])]),e("ChevronIcon",{attrs:{open:t.isOpen(i+"::"+r)}})],1),e("div",{directives:[{name:"show",rawName:"v-show",value:t.isOpen(i+"::"+r),expression:"isOpen(handle + '::' + site)"}],staticClass:"p-3 pt-2 space-y-3"},t._l(n,function(o){return e("div",{key:o.key,staticClass:"border rounded"},[e("div",{staticClass:"flex items-center justify-between px-3 py-2"},[e("div",{staticClass:"font-semibold"},[t._v(" "+t._s(o.key)+" "),e("span",{staticClass:"badge",class:t.badge(o.status)},[t._v(t._s(o.status))])]),e("div",{staticClass:"flex items-center gap-2"},[t.strategy==="manual"?e("div",{staticClass:"hidden md:block"},[e("v-select",{staticStyle:{width:"230px"},attrs:{options:t.acceptOptions,reduce:c=>c.value,clearable:!1},model:{value:t.decisions[o.key],callback:function(c){t.$set(t.decisions,o.key,c)},expression:"decisions[it.key]"}})],1):t._e(),e("button",{staticClass:"icon-btn",attrs:{"aria-expanded":t.isOpen("item::"+o.key)},on:{click:function(c){return t.toggle("item::"+o.key)}}},[e("ChevronIcon",{attrs:{open:t.isOpen("item::"+o.key)}})],1)])]),e("div",{directives:[{name:"show",rawName:"v-show",value:t.isOpen("item::"+o.key),expression:"isOpen('item::' + it.key)"}],staticClass:"px-3 pb-3 space-y-3"},[t.strategy==="manual"?[e("div",{staticClass:"flex flex-wrap gap-3"},[e("div",{staticClass:"flex-1 min-w-[300px]"},[e("div",{staticClass:"text-gray-700 font-semibold mb-1"},[t._v("Current")]),e("pre",{staticClass:"code-block",domProps:{innerHTML:t._s(t.renderCurrentClean(o))}})]),e("div",{staticClass:"flex-1 min-w-[300px]"},[e("div",{staticClass:"text-gray-700 font-semibold mb-1"},[t._v("Incoming")]),e("pre",{staticClass:"code-block",domProps:{innerHTML:t._s(t.renderIncomingClean(o))}})])]),e("div",{staticClass:"mt-3"},[e("div",{staticClass:"text-gray-700 font-semibold mb-1"},[t._v("Final merge")]),e("pre",{staticClass:"code-block"},[t._v(t._s(t.pretty(t.finalMerge(o,t.decisions[o.key]||"incoming"))))])])]:[e("div",{staticClass:"text-gray-600 text-sm"},[t._v("Auto strategy will apply: "),e("b",[t._v(t._s(t.labelFor(t.autoAction)))])])]],2)])}),0)])}),t.totalInSites(a)===0?e("div",{staticClass:"text-gray-500 text-sm px-1"},[t._v(" No changes under this handle. ")]):t._e()],2)])}),t.strategy==="auto"?e("div",{staticClass:"text-gray-600 text-sm"},[t._v(" Will apply "),e("b",[t._v(t._s(t.labelFor(t.autoAction)))]),t._v(" to "+t._s(t.totalChanged)+" changed item"),t.totalChanged!==1?e("span",[t._v("s")]):t._e(),t._v(". ")]):t._e()],2):t._e()])},$=[function(){var s=this,t=s._self._c;return t("div",[t("div",{staticClass:"font-bold text-lg"},[s._v("Import")]),t("div",{staticClass:"text-gray-600"},[s._v(" Upload an exported JSON. We verify integrity, group by "),t("b",[s._v("handle → site")]),s._v(", and show only changed items. ")])])}],E=m(S,j,$,!1,null,"1b383ee9");const A=E.exports,I={components:{ExportPanel:O,ImportPanel:A},data(){return{tab:"export"}}};var N=function(){var t=this,e=t._self._c;return e("div",{staticClass:"space-y-6"},[e("div",{staticClass:"cs-card p-4 flex items-center justify-between"},[e("div",{staticClass:"cs-title"},[t._v("Content Sync")]),e("div",{staticClass:"cs-tabbar"},[e("button",{staticClass:"cs-tab",class:{active:t.tab==="export"},on:{click:function(a){t.tab="export"}}},[t._v("Export")]),e("button",{staticClass:"cs-tab",class:{active:t.tab==="import"},on:{click:function(a){t.tab="import"}}},[t._v("Import")])])]),t.tab==="export"?e("ExportPanel"):e("ImportPanel")],1)},P=[],F=m(I,N,P,!1,null,null);const T=F.exports;Statamic.booting(()=>{Statamic.$components.register("content-sync-utility",T)});
