const l=typeof window<"u"&&window.__CONTENT_SYNC_ENDPOINTS__||{},u=typeof window<"u"&&window.__CONTENT_SYNC_CSRF__||"";async function m(s){const t=await fetch(`${l.options}?type=${encodeURIComponent(s)}`,{credentials:"same-origin"});if(!t.ok)throw new Error(`Options failed (${t.status})`);return(await t.json()).options||[]}async function y(){const s=await fetch(`${l.options}?type=sites`,{credentials:"same-origin"});if(!s.ok)throw new Error(`Sites failed (${s.status})`);return(await s.json()).options||[]}async function g(s){const t=new FormData;Object.entries(s).forEach(([p,d])=>t.append(p,Array.isArray(d)?JSON.stringify(d):d??""));const e=await fetch(l.export,{method:"POST",headers:{"X-CSRF-TOKEN":u},credentials:"same-origin",body:t});if(!e.ok)throw new Error(`Export failed (${e.status})`);const a=await e.blob();let n="export.json";const i=e.headers.get("Content-Disposition")||"",c=/filename="?([^"]+)"?/i.exec(i);c&&(n=c[1]);const o=URL.createObjectURL(a),r=document.createElement("a");r.href=o,r.download=n,document.body.appendChild(r),r.click(),r.remove(),URL.revokeObjectURL(o);try{const p=await a.text();return{count:(JSON.parse(p).items||[]).length,path:n}}catch{return{count:0,path:n}}}async function v(s){const t=new FormData;t.append("file",s);const e=await fetch(l.preview,{method:"POST",headers:{"X-CSRF-TOKEN":u},credentials:"same-origin",body:t});if(!e.ok)throw new Error(`Preview failed (${e.status})`);return e.json()}async function h(s){const t=await fetch(l.commit,{method:"POST",headers:{"X-CSRF-TOKEN":u,"Content-Type":"application/json"},credentials:"same-origin",body:JSON.stringify(s)});if(!t.ok)throw new Error(`Commit failed (${t.status})`);return t.json()}function f(s,t,e,a,n,i,c,o){var r=typeof s=="function"?s.options:s;return t&&(r.render=t,r.staticRenderFns=e,r._compiled=!0),i&&(r._scopeId="data-v-"+i),{exports:s,options:r}}const _={data(){return{types:["collections","taxonomies","navigation","globals","assets"],type:"collections",handles:[],handleOptions:[],siteOptions:[],sites:[],sinceLocal:"",busy:!1,result:null}},async created(){this.siteOptions=await y(),this.handleOptions=await m(this.type)},watch:{async type(s){this.handles=[],this.handleOptions=await m(s)}},methods:{toISO(s){return s?new Date(s).toISOString():""},async runExport(){this.busy=!0;try{const s={type:this.type,handles:this.handles,sites:this.sites,since:this.toISO(this.sinceLocal),out:""};this.result=await g(s),Statamic.$toast.success("Export downloaded.")}catch(s){Statamic.$toast.error(s.message||"Export failed.")}finally{this.busy=!1}}}};var b=function(){var t=this,e=t._self._c;return e("div",{staticClass:"card p-6 space-y-5"},[t._m(0),e("div",{staticClass:"flex flex-wrap gap-4"},[e("div",{staticClass:"w-full lg:w-1/3"},[e("label",{staticClass:"block font-medium mb-1"},[t._v("Type")]),e("v-select",{attrs:{options:t.types,clearable:!1},model:{value:t.type,callback:function(a){t.type=a},expression:"type"}})],1),e("div",{staticClass:"w-full lg:w-1/3"},[e("label",{staticClass:"block font-medium mb-1"},[t._v("Sites")]),e("v-select",{attrs:{options:t.siteOptions,multiple:!0,reduce:a=>a},model:{value:t.sites,callback:function(a){t.sites=a},expression:"sites"}})],1),e("div",{staticClass:"w-full lg:w-1/3"},[e("label",{staticClass:"block font-medium mb-1"},[t._v("Since")]),e("input",{directives:[{name:"model",rawName:"v-model",value:t.sinceLocal,expression:"sinceLocal"}],staticClass:"input",attrs:{type:"datetime-local"},domProps:{value:t.sinceLocal},on:{input:function(a){a.target.composing||(t.sinceLocal=a.target.value)}}}),e("small",{staticClass:"text-gray-500"},[t._v("Optional. Filters by updated_at ≥ since.")])])]),e("div",[e("label",{staticClass:"block font-medium mb-1"},[t._v("Handles")]),e("v-select",{attrs:{options:t.handleOptions,multiple:!0,reduce:a=>a,taggable:!1,placeholder:"Select one or more"},model:{value:t.handles,callback:function(a){t.handles=a},expression:"handles"}}),t.handleOptions.length?t._e():e("div",{staticClass:"mt-2 text-gray-600 text-sm"},[t._v(" No handles available for “"+t._s(t.type)+"”. ")])],1),e("div",{staticClass:"flex items-center gap-3"},[e("button",{staticClass:"btn-primary",attrs:{disabled:t.busy},on:{click:t.runExport}},[t._v(t._s(t.busy?"Exporting…":"Export & Download"))]),t.result?e("span",{staticClass:"text-gray-600"},[t._v("Exported "),e("b",[t._v(t._s(t.result.count))]),t._v(" → "),e("code",[t._v(t._s(t.result.path))])]):t._e()])])},C=[function(){var s=this,t=s._self._c;return t("div",{staticClass:"flex items-start justify-between flex-wrap gap-4"},[t("div",[t("div",{staticClass:"font-bold text-lg"},[s._v("Export")]),t("div",{staticClass:"text-gray-600"},[s._v("Select a type, handles, sites and a “since” date/time. The file downloads locally and includes a tamper-proof signature.")])])])}],x=f(_,b,C,!1,null,null);const w=x.exports,S={name:"ImportPanel",data(){return{loading:!1,error:"",groups:null,type:"",open:{},strategy:"manual",autoAction:"incoming",decisions:{},committing:!1,totalChanged:0}},methods:{toggle(s){this.$set(this.open,s,!this.open[s])},totalInSites(s){return Object.values(s).reduce((t,e)=>t+(Array.isArray(e)?e.length:0),0)},badge(s){return s==="create"?"badge-green":s==="update"?"badge-amber":"badge-gray"},pretty(s){try{return JSON.stringify(s,null,2)}catch{return String(s)}},escape(s){return String(s).replace(/[&<>]/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;"})[t])},renderCurrent(s){if(!s||!s.diff||typeof s.diff!="object")return this.escape(this.pretty((s==null?void 0:s.current)??{}));const t=[];return Object.entries(s.diff).forEach(([e,a])=>{const n=this.escape(typeof a.current=="string"?a.current:this.pretty(a.current));a.status==="removed"?t.push(`<span class="line-del">- ${e}: ${n}</span>`):a.status==="changed"?t.push(`<span class="line-chg">? ${e}: ${n}</span>`):a.status==="added"&&t.push(`<span class="line-ctx">  ${e}: (unchanged in current)</span>`)}),t.join(`
`)||this.escape(this.pretty(s.current??{}))},renderIncoming(s){if(!s||!s.diff||typeof s.diff!="object")return this.escape(this.pretty((s==null?void 0:s.incoming)??{}));const t=[];return Object.entries(s.diff).forEach(([e,a])=>{const n=this.escape(typeof a.incoming=="string"?a.incoming:this.pretty(a.incoming));a.status==="added"?t.push(`<span class="line-add">+ ${e}: ${n}</span>`):a.status==="changed"?t.push(`<span class="line-chg">? ${e}: ${n}</span>`):a.status==="removed"&&t.push(`<span class="line-ctx">  ${e}: (unchanged in incoming)</span>`)}),t.join(`
`)||this.escape(this.pretty(s.incoming??{}))},finalMerge(s,t){if(t==="incoming")return s.incoming;if(t==="current")return s.current;const e=(a,n)=>{if(Array.isArray(a)&&Array.isArray(n))return n;if(a&&typeof a=="object"&&n&&typeof n=="object"){const i={...a};return Object.keys(n).forEach(c=>{i[c]=e(a[c],n[c])}),i}return n!==void 0?n:a};return e(s.current,s.incoming)},onFile(s){const t=s.target.files&&s.target.files[0];t&&(this.loading=!0,this.error="",this.groups=null,this.decisions={},this.open={},v(t).then(e=>{this.type=e.type,this.groups=e.groups||{},this.totalChanged=Object.values(this.groups).reduce((a,n)=>a+this.totalInSites(n),0),this.strategy==="manual"&&Object.values(this.groups).forEach(a=>{Object.values(a).forEach(n=>{n.forEach(i=>this.$set(this.decisions,i.key,"incoming"))})}),Object.keys(this.groups).forEach(a=>this.$set(this.open,a,!0))}).catch(e=>{this.error=(e==null?void 0:e.message)||"Failed to analyze file."}).finally(()=>{this.loading=!1}))},async commit(){this.committing=!0;try{let s;if(this.strategy==="auto")s={type:this.type,strategy:"auto",auto_action:this.autoAction};else{const e=[];Object.values(this.groups).forEach(a=>{Object.values(a).forEach(n=>{n.forEach(i=>e.push({key:i.key,action:this.decisions[i.key]||"incoming"}))})}),s={type:this.type,strategy:"manual",decisions:e}}const t=await h(s);Statamic.$toast.success(`Updated ${t.results.updated}, Created ${t.results.created}, Skipped ${t.results.skipped}`)}catch(s){Statamic.$toast.error((s==null?void 0:s.message)||"Commit failed.")}finally{this.committing=!1}}}};var k=function(){var t=this,e=t._self._c;return e("div",{staticClass:"card p-6 space-y-5"},[e("div",{staticClass:"flex items-start justify-between flex-wrap gap-4"},[t._m(0),e("div",{staticClass:"flex items-center"},[e("input",{attrs:{type:"file",accept:"application/json,.json"},on:{change:t.onFile}})])]),t.loading?e("div",{staticClass:"py-8 text-center"},[e("loading-graphic"),e("div",{staticClass:"mt-2 text-gray-600"},[t._v("Analyzing…")])],1):t._e(),t.error?e("div",{staticClass:"text-red-700 bg-red-50 border border-red-200 rounded p-3"},[t._v(" "+t._s(t.error)+" ")]):t._e(),t.groups?e("div",[e("div",{staticClass:"flex flex-wrap items-end gap-4 mb-4"},[e("div",[e("label",{staticClass:"block font-medium mb-1"},[t._v("Review strategy")]),e("v-select",{staticStyle:{width:"160px"},attrs:{options:["manual","auto"],clearable:!1},model:{value:t.strategy,callback:function(a){t.strategy=a},expression:"strategy"}})],1),t.strategy==="auto"?e("div",[e("label",{staticClass:"block font-medium mb-1"},[t._v("Auto action")]),e("v-select",{staticStyle:{width:"200px"},attrs:{options:["incoming","current","both"],clearable:!1},model:{value:t.autoAction,callback:function(a){t.autoAction=a},expression:"autoAction"}})],1):t._e(),e("div",{staticClass:"ml-auto"},[e("button",{staticClass:"btn-primary",attrs:{disabled:t.committing},on:{click:t.commit}},[t._v(" "+t._s(t.committing?"Committing…":t.strategy==="auto"?"Apply Auto Action":"Complete Import")+" ")])])]),t._l(t.groups,function(a,n){return e("div",{key:n,staticClass:"mb-3"},[e("div",{staticClass:"bg-gray-100 rounded px-3 py-2 font-semibold cursor-pointer",on:{click:function(i){return t.toggle(n)}}},[t._v(" "+t._s(n)+" "),e("span",{staticClass:"text-gray-500"},[t._v("("+t._s(t.totalInSites(a))+")")])]),e("div",{directives:[{name:"show",rawName:"v-show",value:t.open[n],expression:"open[handle]"}],staticClass:"mt-2"},t._l(a,function(i,c){return e("div",{key:n+"::"+c,staticClass:"mb-2"},[e("div",{staticClass:"bg-gray-50 rounded px-3 py-2 cursor-pointer",on:{click:function(o){return t.toggle(n+"::"+c)}}},[e("span",{staticClass:"font-medium"},[t._v("Site:")]),t._v(" "+t._s(c)+" "),e("span",{staticClass:"text-gray-500"},[t._v("("+t._s(i.length)+")")])]),e("div",{directives:[{name:"show",rawName:"v-show",value:t.open[n+"::"+c],expression:"open[handle + '::' + site]"}],staticClass:"mt-2 space-y-3"},t._l(i,function(o){return e("div",{key:o.key,staticClass:"border rounded p-3"},[e("div",{staticClass:"flex items-center justify-between mb-2"},[e("div",{staticClass:"font-semibold"},[t._v(" "+t._s(o.key)+" "),e("span",{staticClass:"badge",class:t.badge(o.status)},[t._v(t._s(o.status))])]),t.strategy==="manual"?e("div",{staticClass:"flex items-center gap-2"},[e("v-select",{staticStyle:{width:"170px"},attrs:{options:["incoming","current","both"],clearable:!1},model:{value:t.decisions[o.key],callback:function(r){t.$set(t.decisions,o.key,r)},expression:"decisions[it.key]"}})],1):t._e()]),t.strategy==="manual"?[e("div",{staticClass:"flex flex-wrap gap-3"},[e("div",{staticClass:"flex-1 min-w-[300px]"},[e("div",{staticClass:"text-gray-700 font-semibold mb-1"},[t._v("Current")]),e("pre",{staticClass:"code-block",domProps:{innerHTML:t._s(t.renderCurrent(o))}})]),e("div",{staticClass:"flex-1 min-w-[300px]"},[e("div",{staticClass:"text-gray-700 font-semibold mb-1"},[t._v("Incoming")]),e("pre",{staticClass:"code-block",domProps:{innerHTML:t._s(t.renderIncoming(o))}})])]),e("div",{staticClass:"mt-3"},[e("div",{staticClass:"text-gray-700 font-semibold mb-1"},[t._v("Final merge")]),e("pre",{staticClass:"code-block"},[t._v(t._s(t.pretty(t.finalMerge(o,t.decisions[o.key]||"incoming"))))])])]:t._e()],2)}),0)])}),0)])}),t.strategy==="auto"?e("div",{staticClass:"text-gray-600 text-sm"},[t._v(" All "+t._s(t.totalChanged)+" changed items will be applied as "),e("b",[t._v(t._s(t.autoAction))]),t._v(". ")]):t._e()],2):t._e()])},O=[function(){var s=this,t=s._self._c;return t("div",[t("div",{staticClass:"font-bold text-lg"},[s._v("Import")]),t("div",{staticClass:"text-gray-600"},[s._v(" Upload an exported JSON. We verify integrity, group by "),t("b",[s._v("handle → site")]),s._v(", and show only changed items. ")])])}],$=f(S,k,O,!1,null,"4fa023ad");const j=$.exports,E={components:{ExportPanel:w,ImportPanel:j},data(){return{tab:"export"}}};var A=function(){var t=this,e=t._self._c;return e("div",{staticClass:"space-y-6"},[e("div",{staticClass:"cs-card p-4 flex items-center justify-between"},[e("div",{staticClass:"cs-title"},[t._v("Content Sync")]),e("div",{staticClass:"cs-tabbar"},[e("button",{staticClass:"cs-tab",class:{active:t.tab==="export"},on:{click:function(a){t.tab="export"}}},[t._v("Export")]),e("button",{staticClass:"cs-tab",class:{active:t.tab==="import"},on:{click:function(a){t.tab="import"}}},[t._v("Import")])])]),t.tab==="export"?e("ExportPanel"):e("ImportPanel")],1)},I=[],N=f(E,A,I,!1,null,null);const T=N.exports;Statamic.booting(()=>{Statamic.$components.register("content-sync-utility",T)});
