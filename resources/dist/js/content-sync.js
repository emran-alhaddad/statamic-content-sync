const c=typeof window<"u"&&window.__CONTENT_SYNC_BASE__||"/cp/content-sync",f=typeof window<"u"&&window.__CONTENT_SYNC_CSRF__||window.Statamic&&Statamic.csrfToken||"";async function m(s){const t=await fetch(`${c}/options?type=${encodeURIComponent(s)}`,{credentials:"same-origin"});if(!t.ok)throw new Error("Options request failed");return(await t.json()).options||[]}async function y(){const s=await fetch(`${c}/options?type=sites`,{credentials:"same-origin"});if(!s.ok)throw new Error("Sites request failed");return(await s.json()).options||[]}async function _(s){const t=new FormData;Object.entries(s).forEach(([p,l])=>t.append(p,Array.isArray(l)?JSON.stringify(l):l??""));const e=await fetch(`${c}/export`,{method:"POST",headers:{"X-CSRF-TOKEN":f},credentials:"same-origin",body:t});if(!e.ok)throw new Error(`Export failed (${e.status})`);const i=await e.blob();let a="export.json";const o=e.headers.get("Content-Disposition")||"",r=/filename="?([^"]+)"?/i.exec(o);r&&(a=r[1]);const d=URL.createObjectURL(i),n=document.createElement("a");n.href=d,n.download=a,document.body.appendChild(n),n.click(),n.remove(),URL.revokeObjectURL(d);try{const p=await i.text();return{count:(JSON.parse(p).items||[]).length,path:a}}catch{return{count:0,path:a}}}async function h(s){const t=new FormData;t.append("file",s);const e=await fetch(`${c}/import/preview`,{method:"POST",headers:{"X-CSRF-TOKEN":f},credentials:"same-origin",body:t});if(!e.ok)throw new Error(`Preview failed (${e.status})`);return e.json()}async function v(s){const t=await fetch(`${c}/import/commit`,{method:"POST",headers:{"X-CSRF-TOKEN":f,"Content-Type":"application/json"},credentials:"same-origin",body:JSON.stringify(s)});if(!t.ok)throw new Error(`Commit failed (${t.status})`);return t.json()}function u(s,t,e,i,a,o,r,d){var n=typeof s=="function"?s.options:s;return t&&(n.render=t,n.staticRenderFns=e,n._compiled=!0),o&&(n._scopeId="data-v-"+o),{exports:s,options:n}}const g={data(){return{types:["collections","taxonomies","navigation","globals","assets"],type:"collections",handles:[],handleOptions:[],siteOptions:[],sites:[],sinceLocal:"",busy:!1,result:null}},async created(){this.siteOptions=await y(),this.handleOptions=await m(this.type)},watch:{async type(s){this.handles=[],this.handleOptions=await m(s)}},methods:{toISO(s){return s?new Date(s).toISOString():""},async runExport(){this.busy=!0;try{const s={type:this.type,handles:this.handles,sites:this.sites,since:this.toISO(this.sinceLocal),out:""};this.result=await _(s),Statamic.$toast.success("Export downloaded.")}catch(s){Statamic.$toast.error(s.message||"Export failed.")}finally{this.busy=!1}}}};var b=function(){var t=this,e=t._self._c;return e("div",{staticClass:"card p-6 space-y-5"},[t._m(0),e("div",{staticClass:"flex flex-wrap gap-4"},[e("div",{staticClass:"w-full lg:w-1/3"},[e("label",{staticClass:"block font-medium mb-1"},[t._v("Type")]),e("v-select",{attrs:{options:t.types,clearable:!1},model:{value:t.type,callback:function(i){t.type=i},expression:"type"}})],1),e("div",{staticClass:"w-full lg:w-1/3"},[e("label",{staticClass:"block font-medium mb-1"},[t._v("Sites")]),e("v-select",{attrs:{options:t.siteOptions,multiple:!0,reduce:i=>i},model:{value:t.sites,callback:function(i){t.sites=i},expression:"sites"}})],1),e("div",{staticClass:"w-full lg:w-1/3"},[e("label",{staticClass:"block font-medium mb-1"},[t._v("Since")]),e("input",{directives:[{name:"model",rawName:"v-model",value:t.sinceLocal,expression:"sinceLocal"}],staticClass:"input",attrs:{type:"datetime-local"},domProps:{value:t.sinceLocal},on:{input:function(i){i.target.composing||(t.sinceLocal=i.target.value)}}}),e("small",{staticClass:"text-gray-500"},[t._v("Optional. Filters by updated_at ≥ since.")])])]),e("div",[e("label",{staticClass:"block font-medium mb-1"},[t._v("Handles")]),e("v-select",{attrs:{options:t.handleOptions,multiple:!0,reduce:i=>i,taggable:!1,placeholder:"Select one or more"},model:{value:t.handles,callback:function(i){t.handles=i},expression:"handles"}}),t.handleOptions.length?t._e():e("div",{staticClass:"mt-2 text-gray-600 text-sm"},[t._v(" No handles available for “"+t._s(t.type)+"”. ")])],1),e("div",{staticClass:"flex items-center gap-3"},[e("button",{staticClass:"btn-primary",attrs:{disabled:t.busy},on:{click:t.runExport}},[t._v(t._s(t.busy?"Exporting…":"Export & Download"))]),t.result?e("span",{staticClass:"text-gray-600"},[t._v("Exported "),e("b",[t._v(t._s(t.result.count))]),t._v(" → "),e("code",[t._v(t._s(t.result.path))])]):t._e()])])},C=[function(){var s=this,t=s._self._c;return t("div",{staticClass:"flex items-start justify-between flex-wrap gap-4"},[t("div",[t("div",{staticClass:"font-bold text-lg"},[s._v("Export")]),t("div",{staticClass:"text-gray-600"},[s._v("Select a type, handles, sites and a “since” date/time. The file downloads locally and includes a tamper-proof signature.")])])])}],w=u(g,b,C,!1,null,null);const x=w.exports,S={data(){return{loading:!1,error:"",diffs:null,decisions:{},committing:!1}},methods:{onFile(s){const t=s.target.files[0];t&&(this.error="",this.diffs=null,this.loading=!0,h(t).then(e=>{this.diffs=e,this.decisions=Object.fromEntries(e.diffs.map(i=>[i.key,"incoming"]))}).catch(e=>{this.error=e.message||"Failed to analyze file."}).finally(()=>{this.loading=!1}))},badge(s){return s==="create"?"badge-green":s==="update"?"badge-amber":"badge-gray"},pretty(s){return JSON.stringify(s,null,2)},renderCurrent(s){const t=[];for(const[e,i]of Object.entries(s.diff))i.status==="removed"?t.push(`<span class="line-del">- ${e}: ${this.escape(i.current)}</span>`):i.status==="changed"?t.push(`<span class="line-chg">? ${e}: ${this.escape(i.current)}</span>`):i.status==="added"&&t.push(`<span class="line-ctx">  ${e}: (unchanged in current)</span>`);return t.join(`
`)||this.escape(this.pretty(s.current))},renderIncoming(s){const t=[];for(const[e,i]of Object.entries(s.diff))i.status==="added"?t.push(`<span class="line-add">+ ${e}: ${this.escape(i.incoming)}</span>`):i.status==="changed"?t.push(`<span class="line-chg">? ${e}: ${this.escape(i.incoming)}</span>`):i.status==="removed"&&t.push(`<span class="line-ctx">  ${e}: (unchanged in incoming)</span>`);return t.join(`
`)||this.escape(this.pretty(s.incoming))},escape(s){return String(typeof s=="string"?s:JSON.stringify(s)).replace(/[&<>]/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;"})[t])},finalMerge(s){const t=this.decisions[s.key]||"incoming";if(t==="incoming")return s.incoming;if(t==="current")return s.current;const e=(i,a)=>{if(Array.isArray(i)&&Array.isArray(a))return a;if(i&&typeof i=="object"&&a&&typeof a=="object"){const o={...i};return Object.keys(a).forEach(r=>o[r]=e(i[r],a[r])),o}return a!==void 0?a:i};return e(s.current,s.incoming)},async commit(){this.committing=!0;try{const s={type:this.diffs.type,decisions:this.diffs.diffs.map(e=>({key:e.key,action:this.decisions[e.key]||"incoming",incoming:e.incoming}))},t=await v(s);Statamic.$toast.success(`Updated ${t.results.updated}, Created ${t.results.created}, Skipped ${t.results.skipped}`)}catch(s){Statamic.$toast.error(s.message||"Commit failed.")}finally{this.committing=!1}}}};var $=function(){var t=this,e=t._self._c;return e("div",{staticClass:"card p-6 space-y-5"},[e("div",{staticClass:"flex items-start justify-between flex-wrap gap-4"},[t._m(0),e("div",{staticClass:"flex items-center"},[e("input",{attrs:{type:"file",accept:"application/json,.json"},on:{change:t.onFile}})])]),t.loading?e("div",{staticClass:"py-8 text-center"},[e("loading-graphic"),e("div",{staticClass:"mt-2 text-gray-600"},[t._v("Analyzing…")])],1):t._e(),t.error?e("div",{staticClass:"text-red-700 bg-red-50 border border-red-200 rounded p-3"},[t._v(" "+t._s(t.error)+" ")]):t._e(),t.diffs&&t.diffs.diffs&&t.diffs.diffs.length?e("div",[e("div",{staticClass:"mb-2 text-gray-600"},[t._v("Changed items: "),e("b",[t._v(t._s(t.diffs.diffs.length))])]),t._l(t.diffs.diffs,function(i){return e("div",{key:i.key,staticClass:"border rounded p-3 mb-4"},[e("div",{staticClass:"flex items-center justify-between mb-2"},[e("div",{staticClass:"font-semibold"},[t._v(" "+t._s(i.key)+" "),e("span",{staticClass:"badge",class:t.badge(i.status)},[t._v(t._s(i.status))])]),e("div",{staticClass:"flex items-center gap-2"},[e("label",{staticClass:"sr-only"},[t._v("Decision")]),e("v-select",{staticStyle:{width:"170px"},attrs:{options:["incoming","current","both"],clearable:!1},model:{value:t.decisions[i.key],callback:function(a){t.$set(t.decisions,i.key,a)},expression:"decisions[item.key]"}})],1)]),e("div",{staticClass:"flex flex-wrap gap-3"},[e("div",{staticClass:"flex-1 min-w-[300px]"},[e("div",{staticClass:"text-gray-700 font-semibold mb-1"},[t._v("Current")]),e("pre",{staticClass:"code-block",domProps:{innerHTML:t._s(t.renderCurrent(i))}})]),e("div",{staticClass:"flex-1 min-w-[300px]"},[e("div",{staticClass:"text-gray-700 font-semibold mb-1"},[t._v("Incoming")]),e("pre",{staticClass:"code-block",domProps:{innerHTML:t._s(t.renderIncoming(i))}})])]),e("div",{staticClass:"mt-3"},[e("div",{staticClass:"text-gray-700 font-semibold mb-1"},[t._v("Final merge")]),e("pre",{staticClass:"code-block"},[t._v(t._s(t.pretty(t.finalMerge(i))))])])])}),e("div",{staticClass:"pt-2"},[e("button",{staticClass:"btn-primary",attrs:{disabled:t.committing},on:{click:t.commit}},[t._v(t._s(t.committing?"Committing…":"Complete Import"))])])],2):t._e()])},k=[function(){var s=this,t=s._self._c;return t("div",[t("div",{staticClass:"font-bold text-lg"},[s._v("Import")]),t("div",{staticClass:"text-gray-600"},[s._v("Upload an exported JSON. We verify integrity, show only affected items, and compute a final merge per item.")])])}],O=u(S,$,k,!1,null,"0256a4c3");const j=O.exports,E={components:{ExportPanel:x,ImportPanel:j},data(){return{tab:"export"}}};var N=function(){var t=this,e=t._self._c;return e("div",{staticClass:"space-y-6"},[e("div",{staticClass:"cs-card p-4 flex items-center justify-between"},[e("div",{staticClass:"cs-title"},[t._v("Content Sync")]),e("div",{staticClass:"cs-tabbar"},[e("button",{staticClass:"cs-tab",class:{active:t.tab==="export"},on:{click:function(i){t.tab="export"}}},[t._v("Export")]),e("button",{staticClass:"cs-tab",class:{active:t.tab==="import"},on:{click:function(i){t.tab="import"}}},[t._v("Import")])])]),t.tab==="export"?e("ExportPanel"):e("ImportPanel")],1)},T=[],F=u(E,N,T,!1,null,null);const I=F.exports;Statamic.booting(()=>{Statamic.$components.register("content-sync-utility",I)});
